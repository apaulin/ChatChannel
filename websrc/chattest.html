<html>
<head>
<script language="javascript">
var connection = null;
var timeRef = 0;
var dateRef = null;


document.addEventListener("keypress", function(e) {
	if(e.keyCode == 13) 
	{
	  gebi("sendTextButton").click(); 
	}
});


var sendLogin = function()
{
	var ip = location.host;
	var wssPort = ":443";
	
	var portCfg = window.location.search.match(/\:(\d+)/);
	if (portCfg == null)
	{
		wssPort = "";
	}
	//alert(ip);
	if (gebi("loginText").value != "")
	{
		connection = new WebSocket('wss://' + ip + wssPort + '/websocket');
		connection.onopen = function () {
			console.log("Connected");
			connection.send('{"type":1, "value":"'+ gebi("loginText").value +'"}'); 
			gebi("sendTextButton").disabled = false;
			gebi("loginButton").disabled = true;
			gebi("loginText").disabled = true;
			gebi("inputText").maxLength = 255-33-gebi("loginText").value.length;
			connection.onmessage = function (message) {
			  console.log("Got message", message.data);
			   
				var t  = gebi("chatSummary");
				var data = JSON.parse(message.data);
				
				if (data.type == 5)
				{
					timeRef = data.value;
					dateRef = new Date();
				}
				else if (data.type == 3)
				{
				 
					var r = t.insertRow(-1);
					var c = r.insertCell(-1);
					c.textContent = data.from;
					
					c = r.insertCell(-1);
					var currentTime = new Date(dateRef.getTime() + (data.time - timeRef) * 1000);
					c.textContent = twoDigits(currentTime.getHours()) + ":" + twoDigits(currentTime.getMinutes()) + ":" + twoDigits(currentTime.getSeconds());

					c = r.insertCell(-1);
					c.textContent = data.value;
					window.scrollTo(0,document.body.scrollHeight)
				}
				else
				{
					console.log("Unknown type of data");
				}
			};
		};
		
	}
	else
	{
		alert("Please enter a name before login in.");
	}

};


// Handle all messages through this callback
  
/*
  switch(data.type) {
    case 1:
      onLogin(data.success);
      break;
    case "offer":
      onOffer(data.offer, data.name);
      break;
    case "answer":
      onAnswer(data.answer);
      break;
    case "candidate":
      onCandidate(data.candidate);
      break;
    case "leave":
      onLeave();
      break;
    default:
      break;
  }
  */

var sendMessage = function()
{
	if (gebi("inputText").value.match(/^\s*$/) == null)
	{
		var msg = new Object();
		msg.type = 3
		msg.from = gebi("loginText").value;
		msg.value = gebi("inputText").value;
		
		connection.send(JSON.stringify(msg, null, 0));
		gebi("inputText").value = "";
	}
}

var connectToMaster = function()
{
	connection.send('{"type":2, "value":"' + gebi("masterAddress").value + '"}');
}

var twoDigits = function(val)
{
	if (val >=0 && val <= 9)
	{
		return "0" + val;
	}
	else
	{
		return val;
	}
}

var gebi = function(id)
{
	return document.getElementById(id);
}



</script>
</head>
<body>
	<table>
		<tr>
			<td><table id="chatSummary"></table></td>
		</tr>
		<tr>
			<td><input type="text" id="loginText" /><input type="button" value="Login" id="loginButton" onclick="sendLogin();"/></td>
		</tr>
		<tr>
			<td><input type="text" id="inputText" maxlength="234"/><input type="button" value="Send Message" id="sendTextButton" disabled onclick="sendMessage();"/></td>
		</tr>
		<tr>
			<td><input type="text" id="masterAddress" value="192.168.0.200" /><input type="button" value="Connect To Master" onclick="connectToMaster();"</td>
		</tr>
	</table>
</body>
</html>
